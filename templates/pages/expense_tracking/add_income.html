{% extends 'layouts/base.html' %}
{% load static %}

{% block title %} - Add {% endblock title %}


{% block content %}{% csrf_token %}
<div class="page-wrapper">
    <!-- Page header -->
    <div class="page-header d-print-none">
        <div class="container-xl">
            <div class="row g-2 align-items-center">
                <div class="col">
                    <h2 class="page-title">
                        Add Income
                    </h2>
                </div>
            </div>
        </div>
    </div>
    <!-- Page body -->
    <div class="page-body">
        <div class="container-xl">
            <div class="card">
                <div class="row g-0">
                    <!--             <div class="col-3 d-none d-md-block border-end">
              <div class="card-body">
                <h4 class="subheader">Business settings</h4>
                <div class="list-group list-group-transparent">
                  <a href="{% url 'settings' %}" class="list-group-item list-group-item-action d-flex align-items-center active">My Account</a>
                  <a href="#" class="list-group-item list-group-item-action d-flex align-items-center">My Notifications</a>
                  <a href="#" class="list-group-item list-group-item-action d-flex align-items-center">Connected Apps</a>
                  <a href="{% url 'settings_plan' %}" class="list-group-item list-group-item-action d-flex align-items-center">Plans</a>
                  <a href="#" class="list-group-item list-group-item-action d-flex align-items-center">Billing & Invoices</a>
                </div>
                <h4 class="subheader mt-4">Experience</h4>
                <div class="list-group list-group-transparent">
                  <a href="#" class="list-group-item list-group-item-action">Give Feedback</a>
                </div>
              </div>
            </div> -->
                    <div class="col d-flex flex-column">
                        <div class="card-body">
                            <!-- Transaction Date & Time -->
                            <h3 class="card-title mt-4">Transaction Date & Time</h3>
                            <div class="row align-items-center ms-3">
                                <div class="col-auto">
                                    <div class="input-icon mb-2">
                                        <input type="text" class="form-control" placeholder="Select a date" id="inputTransactionDatetime" value="">
                                        <!-- <input class="form-control" placeholder="Select a date" id="datepicker-icon"
                                            value=""> -->
                                        <span
                                            class="input-icon-addon"><!-- Download SVG icon from http://tabler-icons.io/i/calendar -->
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24"
                                                viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none"
                                                stroke-linecap="round" stroke-linejoin="round">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                                <path
                                                    d="M4 7a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12z">
                                                </path>
                                                <path d="M16 3v4"></path>
                                                <path d="M8 3v4"></path>
                                                <path d="M4 11h16"></path>
                                                <path d="M11 15h1"></path>
                                                <path d="M12 15v3"></path>
                                            </svg>
                                        </span>
                                    </div>
                                </div>
                                <div class="col-auto">
<!--                                     <button id="reset-button" class="btn btn-primary mb-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round"
                                            class="icon m-0 icon-tabler icons-tabler-outline icon-tabler-refresh">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                            <path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4" />
                                            <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4" />
                                        </svg>
                                    </button> -->
                                </div>
                            </div>
                            <!-- Raw Amount & Currency -->
                            <h3 class="card-title mt-4">Raw Amount & Currency</h3>
                            <div>
                                <div class="row align-items-center g-2 ms-3">
                                    <div class="col-auto ">
                                        <input id="inputRawAmount" data-object="RawAmount" type="number" step="10"
                                            class="input-editable form-control w-auto" value="">
                                    </div>
                                    <div class="col-auto ">
                                        <select id="inputRawCurrency" data-object="RawCurrency" class="input-editable form-control w-auto">
                                            {% for code, item in currencyChoices %}
                                                <option value="{{ code }}">{{ item }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Platform -->
                            <h3 class="card-title mt-4">Platform</h3>
                            <div>
                                <div class="row align-items-center g-2 ms-3">
                                    <div class="col-auto ">
                                        <select id="inputPlatform" data-object="platform" class="input-editable form-control w-auto">
                                            {% for item in platformCategory %}
                                                <option value="{{ item }}">{{ item }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Category -->
                            <h3 class="card-title mt-4">Category</h3>
                            <div>
                                <div class="row align-items-center g-2 ms-3">
                                    <div class="col-auto ">
                                        <select id="inputCategory" data-object="platform" class="input-editable form-control w-auto">
                                            {% for item in incomeCategory %}
                                                <option value="{{ item }}">{{ item }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Note -->
                            <h3 class="card-title mt-3">Note</h3>
                            <div>
                                <div class="row align-items-center g-2 ms-3">
                                    <div class="col-auto ">
                                        <input id="inputNote" data-object="note" type="text"
                                            class="input-editable form-control w-auto" value="">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-transparent mt-auto">
                            <div class="btn-list justify-content-end">
                                <button id="cancelButton" class="btn">
                                    Cancel
                                </button> 
                                <button id="addButton" class="btn btn-primary">
                                    Add
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% include 'includes/footer.html' %}
</div>

{% endblock content %}


{% block extrajs %}


<script>

    document.addEventListener("DOMContentLoaded", function () {
        
        //initially set date-time to today
        const dateInput = document.getElementById('inputTransactionDatetime');
        const todayDateTime = new Date().toISOString();//.split('T')[0];
        dateInput.value = todayDateTime; 
        const picker = new tempusDominus.TempusDominus(document.getElementById('inputTransactionDatetime'), {
            display: {
                components: {
                    calendar: true,
                    date: true,
                    month: true,
                    year: true,
                    decades: true,
                    clock: true,
                    hours: true,
                    minutes: true,
                    seconds: false,
                },
                icons: {
                    time: 'fas fa-clock',
                    date: 'fas fa-calendar',
                },
                buttons: {
                    today: true,
                    //clear: true,
                    close: true,
                },
            },
            //defaultDate: new Date().toISOString(),
            useCurrent: false, // Default value for 'useCurrent' is true, you can adjust it as needed
            localization: {
                locale: 'en',
                format: 'yyyy-MM-DD HH:mm' // Format according to Django's DateTimeField
            }
        });
    });

    //Add button click event
    $('#addButton').on('click', function () {
        console.log('Add is clicked');
        addNewItem();
    });

    function addNewItem() {

        inputTransactionDatetime = $('#inputTransactionDatetime').val();
        inputPlatform = $('#inputPlatform').val();
        inputCategory = $('#inputCategory').val();
        inputRawAmount = $('#inputRawAmount').val();
        inputRawCurrency = $('#inputRawCurrency').val();        
        inputNote = $('#inputNote').val();

        // Send data to Django view using AJAX
        // Get the CSRF token from the form
        let csrfToken = $("input[name=csrfmiddlewaretoken]").val();

        $.ajax({
            url: window.location.href, // Replace with the actual URL of your Django view
            type: 'POST',
            data: {
                'transactionDateTime': inputTransactionDatetime,
                'platform': inputPlatform,
                'category': inputCategory,
                'rawAmount': inputRawAmount,
                'rawCurrency': inputRawCurrency,
                'note': inputNote,
            },
            //dataType: 'json',
            beforeSend: function (xhr) {
                xhr.setRequestHeader("X-CSRFToken", csrfToken);
            },
            success: function (response) {
                console.log('Success addNewItem:', response);
                responseTransactionDateTime = response.data.transactionDateTime;
                responseTransactionPlatform = response.data.platform;
                responseTransactionCategory = response.data.category;
                responseTransactionRawAmount = response.data.rawAmount;
                responseTransactionRawCurrency = response.data.rawCurrency;

                // Create toast HTML and append it to the body
                var toastHtml = `
                    <div class="toast-container position-fixed bottom-0 end-0 p-3">
                        <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
                            <div class="d-flex">
                                <div class="toast-body">
                                    {{responseTransactionRawAmount}} {{responseTransactionRawCurrency}} has been successfully added under {{category}}
                                </div>
                                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Append toast to body
                $('body').append(toastHtml);
                
                // Show toast notification
                var toastEl = document.getElementById('successToast');
                var toast = new bootstrap.Toast(toastEl);
                toast.show();

                // Optionally, remove the toast element after it disappears
                toastEl.addEventListener('hidden.bs.toast', function () {
                    $(toastEl).closest('.toast-container').remove(); // Remove the toast container
                });

            },
            error: function (error) {
                console.log('Error:', error);

            }
        }); 

    }

</script>

{% endblock extrajs %}